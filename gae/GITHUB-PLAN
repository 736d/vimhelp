Old behaviour:
==============

if index changed:
  process-and-put all RawFileInfo from db that also occur on page
  process-and-put all files that occur only on page
process-and-put FAQ (either from db, or a new one)
if index changed but we didn't process tags yet:
  process-tags(need_h2h=False)
    (maybe this can happen if *only* tags changed?)

process-and-put(need_h2h=True):
  if content response:
    process
    save
  elif not modified:
    if redo or (is help.txt and new vim version):
      get from db
      process
      save
    elif is tags and need_h2h:
      get from db
      get_h2h

process:
  h2h = get_h2h
  h2h.add_tags, if faq
  h2h.to_html
  return ProcessedFileHead/Parts

process-tags(need_h2h):
  fetch tags
  process-and-put(need_h2h)

get_h2h:
  if don't have h2h:
    if rdata is tags:
      VimH2H(rdata)
    else:
      process-tags(need_h2h=True)

~~~~~~~~

How this should be simplified/improved:

- Fire off async urlfetch for /runtime/doc
- Gather all RawFileInfo from db
- For each file in /runtime/doc:
  - Use stored sha to determine if need to retrieve
  - Retrieve FAQ always (use ETag)
- tags_event = retrieving_tags ? tags_fetch_event : async_get_from_db('tags')
- If vim version changed:
    help_event = retrieving_help ? help_fetch_event : async_get_from_db('help')
- Wait for faq_fetch_event
- If faq not modified and not retrieving anything else and vim version not
  changed: bail out
- Wait for tags_event
- Create h2h from tags
- Add faq to h2h
- For each fetch_event:
    wait_and_process
- If help_event:
    wait_and_process
